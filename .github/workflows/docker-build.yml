name: Build and Deploy to EC2 with Minikube

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted  # This runs on your self-hosted runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}
          registry: ghcr.io

      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: sinatra-app
          file: sinatra-app/Dockerfile
          push: true
          tags: ghcr.io/triplemcoder14/qacetech-sinatraapp:latest

      - name: Deploy to EC2 and Install Minikube
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ec2-54-195-176-79.eu-west-1.compute.amazonaws.com
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            
            # Debugging SSH connection to the EC2 instance
            echo "Debugging SSH connection..."
            ssh -vvv ubuntu@ec2-54-195-176-79.eu-west-1.compute.amazonaws.com
            echo "SSH connection successful."

            # Update packages
            echo "Updating packages..."
            sudo apt-get update -y

            # Install Docker
            echo "Installing Docker..."
            sudo apt-get install -y docker.io
            sudo usermod -aG docker $USER

            # Install kubectl
            echo "Installing Kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/

            # Install Minikube
            echo "Installing Minikube..."
            curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
            sudo install minikube-linux-amd64 /usr/local/bin/minikube

            # Start Minikube
            echo "Starting Minikube..."
            sudo minikube start --driver=docker

            # Wait for Minikube cluster to be ready
            echo "Waiting for cluster to be ready..."
            sleep 30
            kubectl get nodes

            # Clone the repo if not already present
            echo "Cloning the repo if not already present..."
            if [ ! -d "qacetech-assessment" ]; then
              git clone https://github.com/${{ github.repository }}.git
            fi
            cd qacetech-assessment/
            git pull origin main

            # Deploy to Minikube
            echo "Deploying to Minikube..."
            kubectl apply -f k8s/sinatra-deployment.yml

            # Testing the service
            echo "üåê Testing the service..."
            SERVICE_URL=$(minikube service local-devex-svc -n default --url)
            echo "Access your service at: $SERVICE_URL"
            curl $SERVICE_URL
