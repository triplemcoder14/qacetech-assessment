name: Build, Push Docker Image, and Deploy to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Log in to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}
          registry: ghcr.io

      # Step 4: Build and push Docker image to GHCR
      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: sinatra-app
          dockerfile: Dockerfile
          push: true
          tags: ghcr.io/triplemcoder14/qacetech-sinatraapp:latest

      # Step 5: Set up Kubernetes credentials from the GitHub secret
      - name: Set up K8s kubeconfig
        run: |
          echo "${{ secrets.K8S_KUBECONFIG }}" > ~/.kube/config
          kubectl config view

      # Step 6: Apply Kubernetes Deployment, Service, and HPA
      - name: Apply Kubernetes Resources
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl apply -f hpa.yaml

      # Step 7: Rollout status (optional)
      - name: Check Deployment Status
        run: |
          kubectl rollout status deployment/qace-sinatraapp



#name: Build, Push Docker Image, and Deploy to Kubernetes
#
#on:
#  push:
#    branches:
#      - main
#
#jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    steps:
#      # checkout code
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      # set up Docker buildx
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3
#
#      # og in to gitHub container registry
#      - name: Log in to GitHub Container Registry
#        uses: docker/login-action@v3
#        with:
#          username: ${{ secrets.GHCR_USERNAME }}
#          password: ${{ secrets.GHCR_TOKEN }}
#          registry: ghcr.io
#
#      # uild and push docker image to GHCR
#      - name: Build and push Docker image to GHCR
#        uses: docker/build-push-action@v5
#        with:
#          context: sinatra-app
#          dockerfile: Dockerfile
#          push: true
#          tags: ghcr.io/triplemcoder14/qacetech-sinatraapp:latest
#
#      # set up k8s credentials from the gitHub secret
#      - name: Set up K8s kubeconfig
#        run: |
#          echo "${{ secrets.K8S_KUBECONFIG }}" > ~/.kube/config
#          kubectl config view
#
#      # deploy to k8s
#      - name: Deploy to Kubernetes
#        run: |
#          kubectl set image deployment/qace-sinatraapp qace-sinatraapp=ghcr.io/triplemcoder14/qacetech-sinatraapp:latest
#          kubectl rollout status deployment/qace-sinatraapp
